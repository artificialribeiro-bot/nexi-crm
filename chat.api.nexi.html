<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Nexi CRM - Suporte</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: { 'blue': '#1a2b45', 'orange': '#ff6b35' },
                        "background-light": "#f0f2f5",
                        "background-dark": "#111b21",
                        "chat-bubble-sent": "#d9fdd3",
                        "chat-bubble-sent-dark": "#005c4b",
                        "chat-bubble-received": "#ffffff",
                        "chat-bubble-received-dark": "#202c33",
                    },
                    fontFamily: { sans: ["Poppins", "sans-serif"] },
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1a2b45; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .typing-indicator span { height: 8px; width: 8px; float: left; margin: 0 1px; background-color: #9E9E9E; display: block; border-radius: 50%; opacity: 0.4; animation: bob 1s infinite; }
        .typing-indicator span:nth-of-type(1) { animation-delay: 0s; } .typing-indicator span:nth-of-type(2) { animation-delay: 0.2s; } .typing-indicator span:nth-of-type(3) { animation-delay: 0.4s; }
        @keyframes bob { 10% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #chat-widget-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #chat-popup { height: 70vh; max-height: 590px; width: 90vw; max-width: 400px; transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-transparent" style="pointer-events: none;">

    <div id="chat-widget-container">
        <div id="chat-popup" style="pointer-events: auto;" class="bg-white dark:bg-background-dark rounded-lg shadow-2xl flex-col h-[70vh] max-h-[590px] w-[90vw] max-w-[400px] hidden origin-bottom-right transform scale-95 opacity-0">
            <!-- Chat UI will be built here -->
        </div>

        <button id="chat-fab" style="pointer-events: auto;" class="bg-primary-blue text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-primary-blue/90 transition-transform transform hover:scale-110">
            <span id="fab-icon" class="material-icons text-3xl">chat</span>
            <span id="fab-close-icon" class="material-icons text-3xl hidden">close</span>
        </button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- APIs and Configuration ---
        const API_EMPRESA_URL = 'https://script.google.com/macros/s/AKfycbw0HyUQPS_67MmotBUNj3GI-LjweHrc6ALchR7rJt8eSPwGHitxeh5U9LIDQRtXybcZ/exec';
        const API_CLIENTES_URL = 'https://script.google.com/macros/s/AKfycbwe2m8h2OP0bFpkItF4x5OYRT77Bkhkdvg-EEBEzT_fq59Yz6J8ulcX3iPq9KOjpfcwVg/exec';
        const API_CHAT_URL = 'https://astounding-donut-e0ea90.netlify.app/.netlify/functions/proxy';
        const API_USER_URL = 'https://script.google.com/macros/s/AKfycbzxJFdRr7kqPAQUllOEN6WjroFGsgqvN25FleCDpHyOxQ3r1n_zBMKFblFNt663CVXj/exec';
        const API_PRODUTOS_URL = 'https://script.google.com/macros/s/AKfycbyEFH261J3qybQfBslMZiFQyJh1dJnFtsgswekugKYgkrsV6bxXcMvFu_YGw5K-fS4zLQ/exec';
        const API_KEY = '1526';

        // --- State Management ---
        let selectedCompany = null;
        let chatState = { chatId: null, customerData: { id_usuario: 'anon_' + Date.now() }, currentStep: 'ask_client_name', attendantJoined: false, pollingInterval: null, lastMessageTimestamp: 0 };
        
        // --- UI Elements ---
        const chatPopup = document.getElementById('chat-popup');
        const chatFab = document.getElementById('chat-fab');
        const fabIcon = document.getElementById('fab-icon');
        const fabCloseIcon = document.getElementById('fab-close-icon');
        let messagesContainer, messageInput, sendButton, attachFileButton, fileInput;

        // --- Core UI Functions ---
        function buildChatUI() {
            chatPopup.innerHTML = `
                <div id="loader-full-page" class="absolute inset-0 bg-white/80 dark:bg-black/80 flex justify-center items-center z-50 rounded-lg"><div class="loader"></div></div>
                <header class="bg-primary-blue text-white p-3 flex items-center shadow-md flex-shrink-0 rounded-t-lg">
                    <img id="company-logo" src="" alt="Logo" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                    <div class="ml-3 min-w-0 flex-1">
                        <div id="attendant-info" class="flex items-center hidden">
                             <img id="attendant-photo" src="" alt="Atendente" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                             <div class="ml-3 min-w-0"><h2 id="attendant-name" class="font-semibold text-lg truncate">...</h2><p class="text-xs text-gray-300">Online</p></div>
                        </div>
                        <div id="company-info"><h2 id="company-chat-name" class="font-semibold text-lg truncate">...</h2><p class="text-xs text-gray-300">Suporte</p></div>
                    </div>
                </header>
                <main id="messages-container" class="flex-1 p-4 overflow-y-auto bg-background-light dark:bg-background-dark space-y-4"></main>
                <footer class="bg-white dark:bg-chat-bubble-received-dark p-2 sm:p-3 flex items-center flex-shrink-0 space-x-2 sm:space-x-3 rounded-b-lg">
                    <button id="attach-file-button" disabled class="text-gray-500 hover:text-primary-orange disabled:opacity-50 p-2 rounded-full"><span class="material-icons">attach_file</span></button>
                    <input type="file" id="file-input" class="hidden"/>
                    <input type="text" id="message-input" placeholder="Digite sua mensagem..." disabled class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full px-4 py-2 border dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-orange disabled:opacity-50 min-w-0">
                    <button id="send-button" disabled class="bg-primary-orange text-white rounded-full p-3 flex items-center justify-center disabled:bg-opacity-50 flex-shrink-0"><span class="material-icons">send</span></button>
                </footer>`;
            messagesContainer = document.getElementById('messages-container');
            messageInput = document.getElementById('message-input');
            sendButton = document.getElementById('send-button');
            attachFileButton = document.getElementById('attach-file-button');
            fileInput = document.getElementById('file-input');
        }

        function toggleChatPopup() {
            const isHidden = chatPopup.classList.contains('hidden');
            if (isHidden) {
                if (!chatPopup.innerHTML) { buildChatUI(); startChatFlow(); }
                chatPopup.classList.remove('hidden', 'scale-95', 'opacity-0');
                chatPopup.classList.add('flex', 'scale-100', 'opacity-100');
                fabIcon.classList.add('hidden');
                fabCloseIcon.classList.remove('hidden');
            } else {
                chatPopup.classList.remove('scale-100', 'opacity-100');
                chatPopup.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { chatPopup.classList.add('hidden'); chatPopup.classList.remove('flex'); }, 200);
                fabIcon.classList.remove('hidden');
                fabCloseIcon.classList.add('hidden');
            }
        }
        
        // --- Full Chat Logic ---
        function addMessage(text, sender = 'bot', name = 'NexiBot', isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            let bubbleColor = 'bg-gray-200 dark:bg-gray-700 text-black dark:text-white';
            if (sender === 'user') bubbleColor = 'bg-chat-bubble-sent dark:bg-chat-bubble-sent-dark text-black dark:text-white';
            else if (sender === 'attendant') bubbleColor = 'bg-chat-bubble-received dark:bg-chat-bubble-received-dark text-black dark:text-white';
            messageDiv.innerHTML = `<div class="max-w-xs sm:max-w-sm md:max-w-md px-4 py-2 rounded-lg shadow ${bubbleColor}">${name ? `<p class="font-bold text-xs text-primary-orange">${name}</p>` : ''}<div class="text-sm break-words message-content"></div></div>`;
            const messageContentEl = messageDiv.querySelector('.message-content');
            if (isHtml) messageContentEl.innerHTML = text; else messageContentEl.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getMessageTimestamp(msg) { const dateStr = msg.created_at || msg[""]; return dateStr && typeof dateStr === 'string' ? new Date(dateStr).getTime() : 0; }

        async function normalizeAndDisplayMessage(msg) {
            const normalized = { ...msg };
            if ((!normalized.message || normalized.message === normalized.sender_name) && normalized.attachment && typeof normalized.attachment === 'string') { normalized.message = normalized.attachment; }
            if (!normalized.sender_name || normalized.sender_name.length < 2) { normalized.sender_name = normalized.message; normalized.message = normalized.attachment; }
            const senderType = normalized.sender_user_id === chatState.customerData.id_usuario ? 'user' : 'attendant';
            let content = normalized.message || ""; let isHtmlContent = false;
            const attachmentMatch = content.match(/\*\*attachment_id:([a-zA-Z0-9_-]+)\*\*/); const productMatch = content.match(/\*\*product_id:([a-zA-Z0-9_-]+)\*\*/);
            if (attachmentMatch) { const attachmentDetails = await fetchAttachmentDetails(attachmentMatch[1]); if (attachmentDetails) { content = `<a href="${attachmentDetails.public_url}" target="_blank" class="flex items-center text-blue-600 underline"><span class="material-icons text-base mr-1">attach_file</span> ${attachmentDetails.file_name}</a>`; isHtmlContent = true; } }
            else if (productMatch) { const productDetails = await fetchProductDetails(productMatch[1]); if (productDetails) { const price = parseFloat(productDetails.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); content = `<div class="mt-2 border-t pt-2 flex items-start space-x-3"><img src="${productDetails.foto1 || 'https://placehold.co/64x64/eee/ccc?text=Produto'}" class="w-16 h-16 rounded-md object-cover"/><div><p class="font-bold">${productDetails.nome}</p><p class="text-xs">${(productDetails.descricao || '').substring(0, 50)}...</p><p class="text-sm font-semibold mt-1">${price}</p></div></div>`; isHtmlContent = true; } }
            addMessage(content, senderType, normalized.sender_name, isHtmlContent);
        }

        async function handleUserInput(text) {
            disableInput(); addMessage(text, 'user', null); await new Promise(r => setTimeout(r, 800));
            messagesContainer.innerHTML += `<div id="typing-indicator" class="flex justify-start"><div class="max-w-xs lg:max-w-md px-4 py-3 rounded-lg shadow bg-chat-bubble-received dark:bg-chat-bubble-received-dark"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
            messagesContainer.scrollTop = messagesContainer.scrollHeight; await new Promise(r => setTimeout(r, 1000)); await processStep(text);
            const t = document.getElementById('typing-indicator'); if (t) t.remove(); if (chatState.currentStep !== 'done') enableInput();
        }

        async function processStep(input) {
             switch (chatState.currentStep) {
                case 'ask_client_name': chatState.customerData.nome = input; addMessage(`Prazer, ${input}! Agora, por favor, digite seu CPF (apenas números).`); chatState.currentStep = 'ask_cpf'; break;
                case 'ask_cpf': const cpf = input.replace(/\D/g, ''); if (cpf.length !== 11) { addMessage("CPF inválido. Por favor, digite um CPF com 11 dígitos."); return; } chatState.customerData.cpf = cpf; await checkCustomerExists(cpf); break;
                case 'ask_celular': chatState.customerData.celular = input.replace(/\D/g, ''); addMessage("Qual o seu e-mail?"); chatState.currentStep = 'ask_email'; break;
                case 'ask_email': chatState.customerData.email = input; addMessage("Ótimo. Agora, sua data de nascimento (formato AAAA-MM-DD)."); chatState.currentStep = 'ask_birth_date'; break;
                case 'ask_birth_date': chatState.customerData.data_nascimento = input; addMessage("Por favor, informe seu CEP para localizarmos sua cidade e estado. (Ou digite 'manual' para inserir manualmente)"); chatState.currentStep = 'ask_cep'; break;
                case 'ask_cep': if (input.toLowerCase() === 'manual') { addMessage("Ok. Qual é a sua cidade?"); chatState.currentStep = 'ask_city'; } else { await handleCepInput(input); } break;
                case 'ask_city': chatState.customerData.cidade = input; addMessage("E qual o seu estado (sigla, ex: SP)?"); chatState.currentStep = 'ask_state'; break;
                case 'ask_state': chatState.customerData.estado = input; confirmAndRegister(); break;
                case 'confirm_and_register': if (input.toLowerCase() === 'sim') { addMessage("Obrigado! Criando seu cadastro..."); await registerCustomer(); } else { addMessage("Entendido. Sem seu consentimento, não podemos prosseguir. O chat será encerrado."); chatState.currentStep = 'done'; } break;
                case 'awaiting_attendant': await sendUserMessageToChat(input); break;
            }
        }

        function confirmAndRegister() {
            const summary = `<strong>Nome:</strong> ${chatState.customerData.nome}<br><strong>CPF:</strong> ${chatState.customerData.cpf}<br><strong>Celular:</strong> ${chatState.customerData.celular}<br><strong>Email:</strong> ${chatState.customerData.email}<br><strong>Nascimento:</strong> ${chatState.customerData.data_nascimento}<br><strong>Cidade:</strong> ${chatState.customerData.cidade}<br><strong>Estado:</strong> ${chatState.customerData.estado}`;
            addMessage(`Para finalizar, por favor, confirme os dados:<br><br>${summary}`, 'bot', 'NexiBot', true);
            setTimeout(() => { addMessage("Os dados estão corretos e você aceita os termos da LGPD do Nexi CRM? (Digite 'sim' ou 'não')"); chatState.currentStep = 'confirm_and_register'; }, 1000);
        }

        async function handleCepInput(cep) {
            const cleanCep = cep.replace(/\D/g, ''); if (cleanCep.length !== 8) { addMessage("CEP inválido. Tente novamente ou digite 'manual'."); return; }
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`); const data = await response.json();
                if (data.erro) { addMessage("Não encontrei este CEP. Por favor, digite sua cidade."); chatState.currentStep = 'ask_city'; }
                else { chatState.customerData.cidade = data.localidade; chatState.customerData.estado = data.uf; addMessage(`Endereço encontrado: ${data.localidade} - ${data.uf}.`); confirmAndRegister(); }
            } catch (error) { addMessage("Tive um problema ao buscar o CEP. Por favor, digite sua cidade."); chatState.currentStep = 'ask_city'; }
        }

        async function checkCustomerExists(cpf) {
            try {
                const url = `${API_CLIENTES_URL}?action=getByCpf&cpf=${cpf}&id_empresa=${selectedCompany.empresa_id}`;
                const response = await fetch(url); const result = await response.json();
                if (result.success && result.data) { addMessage(`Encontrei seu cadastro, ${result.data.nome}! Um momento...`); chatState.customerData = result.data; await createSupportChat(); }
                else { addMessage("Não encontrei seu cadastro. Vamos criar um rapidamente."); setTimeout(() => { addMessage("Qual seu celular com DDD?"); chatState.currentStep = 'ask_celular'; }, 1000); }
            } catch (error) { addMessage("Tive um problema para verificar seu cadastro.", 'bot', 'Sistema'); }
        }

        async function registerCustomer() {
            try {
                const params = new URLSearchParams({ action: 'register', ...chatState.customerData, id_empresa: selectedCompany.empresa_id });
                const url = `${API_CLIENTES_URL}?${params.toString()}`; const response = await fetch(url); const result = await response.json();
                if (result.success && result.data) { chatState.customerData.id_usuario = result.data.id_usuario; addMessage("Cadastro realizado! Criando seu ticket de suporte..."); await createSupportChat(); }
                else { addMessage(`Erro ao criar cadastro: ${result.message}`); chatState.currentStep = 'done'; }
            } catch (error) { addMessage("Tive um problema para realizar seu cadastro.", 'bot', 'Sistema'); chatState.currentStep = 'done'; }
        }

        async function createSupportChat() {
            const body = { action: 'create_chat', key: API_KEY, creator_user_id: chatState.customerData.id_usuario, creator_email: chatState.customerData.email || '', title: `Suporte para ${chatState.customerData.nome}`, send_email_summary: true };
            try {
                const response = await fetch(API_CHAT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const result = await response.json(); if (result.success && result.data) {
                    chatState.chatId = result.data.chat_id; const successMessage = `Seu atendimento foi iniciado!<br><br>O ID do seu chat é: <strong class="text-lg">${chatState.chatId}</strong><br><br>Guarde este código para retomar a conversa no futuro.`;
                    addMessage(successMessage, 'bot', 'NexiBot', true);
                    setTimeout(() => { addMessage("Um de nossos atendentes irá se conectar em breve."); addMessage("Enquanto aguarda, você pode descrever seu problema ou enviar um anexo."); chatState.currentStep = 'awaiting_attendant'; startPolling(); }, 1500);
                } else { addMessage(`Não consegui criar o chat: ${result.message || 'Tente novamente.'}`); chatState.currentStep = 'done'; }
            } catch (error) { addMessage("Ocorreu um erro de rede ao criar o chat.", 'bot', 'Sistema'); chatState.currentStep = 'done'; }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            disableInput(); addMessage(`Enviando anexo: ${file.name}...`, 'bot', 'Sistema');
            const originalButtonText = sendButton.innerHTML; sendButton.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
            try {
                const base64String = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); });
                const attachmentBody = { action: 'upload_attachment', key: API_KEY, chat_id: chatState.chatId, message_id: 'temp-' + Date.now(), file_name: file.name, file_type: file.type, file_data: base64String, uploaded_by: chatState.customerData.id_usuario };
                const attachmentResponse = await fetch(API_CHAT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(attachmentBody) });
                const attachmentResult = await attachmentResponse.json(); if (!attachmentResult.success) throw new Error(attachmentResult.message || 'Falha ao enviar o anexo.');
                const finalMessage = `**attachment_id:${attachmentResult.data.attachment_id}**`; await sendUserMessageToChat(finalMessage);
                await normalizeAndDisplayMessage({ sender_user_id: chatState.customerData.id_usuario, sender_name: chatState.customerData.nome, message: finalMessage, created_at: new Date().toISOString() });
            } catch (error) { addMessage(`Erro ao enviar o anexo: ${error.message}`, 'bot', 'Sistema'); }
            finally { enableInput(); sendButton.innerHTML = originalButtonText; fileInput.value = ''; }
        }

        async function fetchAttendantDetails(id) { try { const url = `${API_USER_URL}?action=get&key=${API_KEY}&id=${id}`; const response = await fetch(url); const result = await response.json(); if (result.success) return result.data; } catch (e) { } return null; }
        
        function startPolling() {
            if (chatState.pollingInterval) clearInterval(chatState.pollingInterval);
            chatState.pollingInterval = setInterval(async () => {
                try {
                    const chatUrl = `${API_CHAT_URL}?action=get_chat&key=${API_KEY}&chat_id=${chatState.chatId}`; const chatResponse = await fetch(chatUrl); if (!chatResponse.ok) return;
                    const chatResult = await chatResponse.json(); if (chatResult.success) {
                        const chatData = chatResult.data; if (chatData.attendant_user_id && !chatState.attendantJoined) {
                            chatState.attendantJoined = true; const attendantDetails = await fetchAttendantDetails(chatData.attendant_user_id);
                            const attendantName = attendantDetails ? attendantDetails.nome : (chatData.attendant_email || 'Atendente');
                            document.getElementById('company-info').classList.add('hidden'); const attendantInfo = document.getElementById('attendant-info');
                            if (attendantDetails && attendantDetails.foto) document.getElementById('attendant-photo').src = attendantDetails.foto;
                            document.getElementById('attendant-name').textContent = attendantName; attendantInfo.classList.remove('hidden');
                            addMessage(`Olá! Meu nome é ${attendantName} e vou te ajudar.`, 'attendant', attendantName);
                        }
                        const status = chatData.status || chatData.updated_at; if (status === 'fechado' || status === 'cancelado') {
                            clearInterval(chatState.pollingInterval); addMessage("Este atendimento foi finalizado.", 'bot', 'Sistema'); disableInput(); return;
                        }
                    }
                    const messagesUrl = `${API_CHAT_URL}?action=get_messages&key=${API_KEY}&chat_id=${chatState.chatId}&page_size=50`; const messagesResponse = await fetch(messagesUrl); if (!messagesResponse.ok) return;
                    const messagesResult = await messagesResponse.json(); if (messagesResult.success && messagesResult.data && messagesResult.data.messages) {
                        const newMessages = messagesResult.data.messages.filter(msg => getMessageTimestamp(msg) > chatState.lastMessageTimestamp);
                        if (newMessages.length > 0) {
                            newMessages.sort((a, b) => getMessageTimestamp(a) - getMessageTimestamp(b));
                            for (const msg of newMessages) { await normalizeAndDisplayMessage(msg); const newTimestamp = getMessageTimestamp(msg); if (newTimestamp > chatState.lastMessageTimestamp) chatState.lastMessageTimestamp = newTimestamp; }
                        }
                    }
                } catch (error) { }
            }, 5000);
        }

        async function fetchProductDetails(id) { try { if (!selectedCompany) return null; const url = `${API_PRODUTOS_URL}?action=getByCompany&id_empresa=${selectedCompany.empresa_id}`; const res = await fetch(url); const result = await res.json(); if (result.success && result.data) return result.data.find(p => p.id_produto === id); } catch (e) { } return null; }
        async function fetchAttachmentDetails(id) { try { const url = `${API_CHAT_URL}?action=get_attachment&key=${API_KEY}&attachment_id=${id}`; const res = await fetch(url); const result = await res.json(); return result.success ? result.data : null; } catch (e) { } return null; }
        
        async function sendUserMessageToChat(message) {
            const body = { action: 'add_message', key: API_KEY, chat_id: chatState.chatId, sender_user_id: chatState.customerData.id_usuario, sender_name: chatState.customerData.nome, message: message };
            try {
                const res = await fetch(API_CHAT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const result = await res.json();
                if (result.success && result.data) { const timestamp = getMessageTimestamp(result.data); if (timestamp > chatState.lastMessageTimestamp) chatState.lastMessageTimestamp = timestamp; }
            } catch (error) { addMessage("Não foi possível enviar sua mensagem.", 'bot', 'Sistema'); }
        }

        function enableInput() { if (chatState.currentStep !== 'done') { messageInput.disabled = false; sendButton.disabled = false; attachFileButton.disabled = !chatState.chatId; messageInput.focus(); } }
        function disableInput() { messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; }
        
        function startChatFlow() {
            const loader = chatPopup.querySelector('#loader-full-page');
            if(loader) loader.style.display = 'none';
            document.getElementById('company-logo').src = selectedCompany.foto_link || 'https://placehold.co/40x40/ffffff/1a2b45?text=N';
            document.getElementById('company-chat-name').textContent = selectedCompany.nome;
            sendButton.addEventListener('click', () => { const text = messageInput.value.trim(); if (text) { handleUserInput(text); messageInput.value = ''; } });
            messageInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !sendButton.disabled) { sendButton.click(); } });
            attachFileButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            setTimeout(() => { addMessage(`Olá! Bem-vindo(a) ao suporte da <strong>${selectedCompany.nome}</strong>.`, 'bot', 'NexiBot', true); setTimeout(() => { addMessage("Para começarmos, qual é o seu nome?"); enableInput(); }, 1200); }, 500);
        }

        async function initializePlugin() {
            const urlParams = new URLSearchParams(window.location.search);
            const empresaId = urlParams.get('empresa_id');
            if (!empresaId) { chatFab.style.display = 'none'; return; }
            try {
                const response = await fetch(`${API_EMPRESA_URL}?action=get_empresa&key=${API_KEY}&empresa_id=${empresaId}`);
                const result = await response.json();
                if (result.success && result.data) { selectedCompany = result.data; }
                else { throw new Error(result.message || 'Company not found.'); }
            } catch (error) { console.error("Nexi Chat Plugin Error:", error.message); chatFab.style.display = 'none'; }
        }

        chatFab.addEventListener('click', toggleChatPopup);
        initializePlugin();
    });
    </script>
</body>
</html>

